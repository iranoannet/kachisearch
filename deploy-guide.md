# カチサーチ - FileZillaデプロイガイド

このガイドでは、カチサーチをXserverにFileZillaを使用してデプロイする方法を説明します。

## 前提条件

- Node.js（バージョン16以上）がローカル環境にインストールされていること
- FileZillaがインストールされていること
- Xserverのアカウントを持っていること
- Google Spreadsheet APIのサービスアカウント認証情報を取得済みであること

## 1. プロジェクトの準備

### 1.1 依存パッケージのインストール

```bash
# プロジェクトルートディレクトリで実行
npm install
npm install google-spreadsheet google-auth-library
```

### 1.2 Google APIの認証情報を設定

1. Google Cloud Consoleから取得したサービスアカウントのJSONファイルを `scripts/credentials.json` として保存します。
2. `scripts/sync-spreadsheet.js` ファイル内の `SPREADSHEET_IDS` 配列に、実際のスプレッドシートIDを設定します。

### 1.3 静的サイトのビルド

```bash
# プロジェクトルートディレクトリで実行
npm run build
```

ビルドが成功すると、`out` ディレクトリに静的ファイルが生成されます。

## 2. FileZillaを使用したデプロイ

### 2.1 FileZillaの設定

1. FileZillaを起動し、「ファイル」→「サイトマネージャー」を開きます。
2. 「新しいサイト」をクリックし、以下の情報を入力します：
   - ホスト名: sv16380.xserver.jp
   - ユーザー名: xs704823
   - ポート: 21
   - パスワード: （Xserverのパスワード）
3. 「接続」をクリックしてサーバーに接続します。

### 2.2 ファイルのアップロード

1. ローカルの `out` ディレクトリ内のすべてのファイルを選択します。
2. Xserverの公開ディレクトリ（通常は `public_html` または `htdocs`）にドラッグ＆ドロップします。
3. 転送が完了するまで待ちます。

### 2.3 画像ファイルのアップロード

1. カード画像を `public/card-images` ディレクトリに配置します。
   - 画像ファイル名は商品IDと一致させてください（例：`120.jpg`）
2. `public/card-images` ディレクトリ内のすべての画像ファイルを選択します。
3. Xserverの `public_html/card-images`（または `htdocs/card-images`）ディレクトリにアップロードします。

## 3. スプレッドシート同期の設定

### 3.1 スクリプトのアップロード

1. `scripts` ディレクトリ内のすべてのファイルを選択します。
2. Xserverの非公開ディレクトリ（例：`/home/xs704823/scripts`）にアップロードします。

### 3.2 必要なパッケージのインストール（Xserverでサポートされている場合）

Xserverでは標準でNode.jsが利用できない場合がありますが、サポートされている場合は以下の手順で必要なパッケージをインストールします：

```bash
# SSHでXserverに接続した場合
cd /home/xs704823/scripts
npm install google-spreadsheet google-auth-library
```

### 3.3 定期実行の設定

Xserverでcronが利用可能な場合は、以下の手順で定期実行を設定します：

1. Xserverの管理画面にログインします。
2. cron設定画面を開きます。
3. 以下のようなcron設定を追加します（1日3回実行の例）：

```
0 8,14,20 * * * cd /home/xs704823/scripts && node update-site.js >> /home/xs704823/scripts/update.log 2>&1
```

## 4. 代替方法：ローカルでの更新とデプロイ

Xserverで直接Node.jsスクリプトを実行できない場合は、以下の代替方法を使用します：

1. ローカル環境で定期的にスプレッドシートからデータを取得し、静的サイトを生成します：

```bash
# ローカル環境で実行
node scripts/update-site.js
```

2. 生成された `out` ディレクトリの内容をFileZillaを使用してXserverにアップロードします。

3. この処理を自動化するために、ローカルPCのタスクスケジューラ（Windowsの場合）またはcron（MacやLinuxの場合）を設定します。

## 5. トラブルシューティング

### 5.1 画像が表示されない場合

- 画像ファイル名が商品IDと一致しているか確認してください。
- 画像ファイルが正しいディレクトリ（`card-images/`）にアップロードされているか確認してください。

### 5.2 データが更新されない場合

- スプレッドシートのIDが正しく設定されているか確認してください。
- Google APIの認証情報が正しいか確認してください。
- スプレッドシートの列名（A列、B列など）が正しく設定されているか確認してください。

### 5.3 デプロイ後にページが表示されない場合

- `.htaccess` ファイルが正しく設定されているか確認してください。
- Xserverの設定でURLリライトが有効になっているか確認してください。

## 6. 連絡先

問題が解決しない場合は、以下の連絡先までお問い合わせください：

- 会社名: テストA
- 事業内容: テストB
- 連絡先情報: テストC
